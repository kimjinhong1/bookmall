<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<!-- mapper파일의 이름 -->
<mapper namespace="book"> 

	<!-- 코드의 중복을 줄이기 위해 -->
	<sql id = "boardWhere">
		<where>
			<if test ="searchType ==''">   
			 	
			 </if>
		</where>
	</sql>
	
	<!-- 도서 하나만 선택 -->
	<select id="selectOne" parameterType="int" resultType="bookmall.book.BookVo">
		SELECT *
		FROM book
		WHERE bookno = #{bookno}
	</select>
	
	<!-- 도서 목록 -->
	<select id="selectList" resultType="bookmall.book.BookVo" parameterType="bookmall.book.BookVo">
		SELECT *
		FROM book
		WHERE NOT bstatus = 1
	</select>
	
	<!-- 도서 상세 정보 - 카테고리 -->
	<select id="selectCate" parameterType="int" resultType="java.util.LinkedHashMap">
		SELECT
    		(SELECT bcategoryname 
    		FROM book_category 
    		WHERE bcategoryno = bc.bparentno) AS parentname,
    		bcategoryname
		FROM book_category AS bc
		WHERE bcategoryno IN (SELECT bcategoryno 
							FROM book_category_mapping 
							WHERE bookno = #{bookno});
	</select>
	
	<!-- 페이징 처리를 위한 갯수 카운팅 -->
	<select id="count" resultType="int" parameterType="bookmall.book.BookVo">
		SELECT COUNT(*) 
		FROM book
	</select>
	
	<!-- (관리자) 도서 등록시 필요한 카테고리 검색 -->
	<select id="cateList" parameterType="java.util.HashMap" resultType="java.util.LinkedHashMap">
		SELECT
			(SELECT bcategoryname
			FROM book_category
			WHERE bcategoryno = bc.bparentno) AS parentname,
			bclassify,
			bcategoryname,
			bcategoryno,
			blevel
		FROM book_category AS bc
		WHERE bclassify = #{bclassify}   
		<if test="blevel == 0">
			AND blevel = 1
		</if>   
		<if test="blevel != 0">
			AND blevel = 2 AND bparentno = #{bcategoryno}
		</if>
	</select>
	
	<!-- (관리자) 도서 등록 -->
	<insert id="insert" parameterType="bookmall.book.BookVo">
		INSERT INTO book (
			isbn, btitle_first, btitle_second, author, publisher, pubdate, price, discountrate, 
			salesprice, classify, translator, bpages, bweight, bwidth, bvertical, bheight, 
			bstack, bintroduce, bindex, bthumb_org, bthumb_real, regdate
		) VALUES (
			#{isbn}, #{btitle_first}, #{btitle_second}, #{author}, #{publisher}, #{pubdate}, #{price}, #{discountrate},
			#{salesprice}, #{classify}, #{translator}, #{bpages}, #{bweight}, #{bwidth}, #{bvertical}, #{bheight}, 
			#{bstack}, #{bintroduce}, #{bindex}, #{bthumb_org}, #{bthumb_real}, NOW()  
		)
	</insert>
	
	<!-- (관리자)  -->
	<!-- (관리자) 도서 등록시 북_카테고리_매핑 테이블에 정보 등록 -->
	<insert id="insertMapping" parameterType="bookmall.bookcategory.BookCategoryMappingVO">
		<selectKey keyProperty="bookno" resultType="int" order="BEFORE">
			SELECT MAX(bookno) FROM book
		</selectKey>
		INSERT INTO book_category_mapping (
			bookno, bcategoryno
		) VALUES (
			#{bookno}, #{bcategoryno}
		)
	</insert>
	
	<!-- (관리자) 도서 수정 -->
	<update id="update" parameterType="bookmall.book.BookVo">
		UPDATE book
		SET btitle_first = #{btitle_first},
			btitle_second = #{btitle_second},
			author = #{author},
			publisher = #{publisher},
			pubdate = #{pubdate},
			price = #{price},
			discountrate = #{discountrate},
			salesprice = #{salesprice},
			classify = #{classify},
			translator = #{translator},
			bpages = #{bpages},
			bweight = #{bweight},
			bwidth = #{bwidth},
			bvertical = #{bvertical},
			bheight = #{bheight},
			bintroduce = #{bintroduce},
			bindex = #{bindex},
			bthumb_org = #{bthumb_org},
			bthumb_real = #{bthumb_real},
			bstack = #{bstack},
			moddate = NOW()
		WHERE bookno = #{bookno}
	</update>
	
	<!-- (관리자) 도서 삭제 -->
	<update id="delete" parameterType="bookmall.book.BookVo">
		UPDATE book 
		SET bstatus = 1
		WHERE bookno = #{bookno}
	</update>
	
	<select id="isbnCheck" parameterType="String" resultType="int">
		SELECT COUNT(*) FROM book WHERE isbn = #{isbn}
	</select>
</mapper>